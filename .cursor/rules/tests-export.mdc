---
description: RÃ¨gles pour tester l'export Notion
globs: ["tests/test_export_*.py", "tests/run_export_tests.py"]
alwaysApply: false
---

# Tests Export Notion

## ðŸŽ¯ Objectif

Suite de tests modulaire pour valider l'export Notion.
Permet de dÃ©tecter rapidement si un champ n'est pas exportÃ© correctement.

---

## ðŸ“Š Structure (3 niveaux)

### 1. `test_export_extraction.py` (Unitaire, < 0.5s)
**Teste :** Extraction markdown â†’ donnÃ©es Python

```python
def test_extract_espece(sample_personnage_content):
    espece = extract_field("EspÃ¨ce", content)
    assert espece == "Humain modifiÃ©"
```

### 2. `test_export_payload.py` (Unitaire, < 0.5s)
**Teste :** DonnÃ©es â†’ Payload Notion API

```python
def test_payload_has_espece(sample_personnage_content):
    props = build_notion_properties_personnage(content)
    assert "EspÃ¨ce" in props
```

### 3. `test_export_integration.py` (IntÃ©gration, ~10s)
**Teste :** Payload â†’ Notion API rÃ©elle (sandbox)

```python
@pytest.mark.integration
def test_create_personnage_basic(notion_headers):
    page_data = create_notion_page(...)
    assert page_data["url"] is not None
```

**Cleanup automatique :** Toutes les pages crÃ©Ã©es sont archivÃ©es aprÃ¨s chaque test.

---

## ðŸš€ ExÃ©cution

**âš ï¸ TOUJOURS utiliser le chemin absolu du projet :**
```powershell
python "F:\Projets\Langgraph Alteir\tests\run_export_tests.py"
```

## Commandes

### DÃ©veloppement (quotidien)
```powershell
python "F:\Projets\Langgraph Alteir\tests\run_export_tests.py" quick
# 38 tests en < 1s, pas d'API
```

### Validation complÃ¨te
```bash
python tests/run_export_tests.py full
# 45 tests en ~10s, avec API Notion
```

### Tests spÃ©cifiques
```bash
# Par nom
pytest tests/ -k "espece" -v

# Par classe
pytest tests/test_export_extraction.py::TestExtractionRelations -v

# Par fichier
pytest tests/test_export_extraction.py -v
```

---

## âœ… Principe

**Si un champ n'est pas exportÃ© correctement, un test DOIT Ã©chouer.**

### Workflow dÃ©tection bug
1. User : "Le champ X n'est pas exportÃ©"
2. IA : `pytest tests/ -k "champ_x" -v`
3. Si tests passent â†’ Bug dans l'interface ou API
4. Si tests Ã©chouent â†’ Bug dans extraction ou payload

---

## ðŸ“ Ajouter un nouveau champ

### 1. Fixture (markdown test)
```python
@pytest.fixture
def sample_personnage_content():
    return """
    ...
    - **Nouveau Champ**: Valeur test
    ...
    """
```

### 2. Test extraction
```python
def test_extract_nouveau_champ(sample_personnage_content):
    val = extract_field("Nouveau Champ", content)
    assert val == "Valeur test"
```

### 3. Test payload
```python
def test_payload_has_nouveau_champ(sample_personnage_content):
    props = build_notion_properties_personnage(content)
    assert "Nouveau Champ" in props
    assert props["Nouveau Champ"]["type"]["value"] == "attendu"
```

### 4. Relancer
```bash
python tests/run_export_tests.py quick
```

---

## ðŸ§¹ Maintenance

- **IsolÃ©s** : Pas de dÃ©pendances entre tests
- **Rapides** : Tests unitaires < 1s
- **Propres** : Cleanup auto (intÃ©gration)
- **Extensibles** : Nouveau champ = quelques lignes

### Checklist avant commit
```bash
# Tests rapides (obligatoire)
python tests/run_export_tests.py quick

# Tests complets (recommandÃ©)
python tests/run_export_tests.py full
```

---

## ðŸ” Debug

### Champ manquant
```bash
# 1. VÃ©rifier extraction
pytest tests/test_export_extraction.py -k "nom_champ" -v

# 2. Si OK, vÃ©rifier payload
pytest tests/test_export_payload.py -k "nom_champ" -v

# 3. Si OK, vÃ©rifier API
pytest tests/test_export_integration.py -k "nom_champ" -v -m integration
```

### Tests qui Ã©chouent
```bash
# Voir dÃ©tails complets
pytest tests/ -v --tb=long

# ArrÃªter au premier Ã©chec
pytest tests/ -v -x

# Afficher les prints
pytest tests/ -v -s
```

---

## ðŸ“š RÃ©fÃ©rences

- **Script helper :** `tests/run_export_tests.py`
- **Doc technique :** `tests/README_EXPORT_TESTS.md`
- **Fixtures :** `tests/test_export_extraction.py`
- **Helpers :** `tests/test_export_payload.py`
- **Config :** `pytest.ini`

---

## âš ï¸ Important

### Ne JAMAIS crÃ©er de fichiers temporaires de test
```bash
# âŒ Interdit
touch test_temp.py
touch debug_fuzzy.py

# âœ… Utiliser Ã  la place
python -c "from module import func; print(func())"

# âœ… Ou ajouter dans module
if __name__ == "__main__":
    # Tests rapides ici
```

Voir `.cursor/rules/debug-practices.mdc` pour dÃ©tails.

---

## ðŸŽ¯ Objectif Final

Tests **rapides, fiables, maintenables**.
DÃ©tecter immÃ©diatement si l'export est cassÃ©.
